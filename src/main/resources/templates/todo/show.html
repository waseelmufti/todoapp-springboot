<!DOCTYPE html>
<html
  th:replace="~{layouts/layout :: layout(~{::title}, ~{::#content}, ~{}, ~{::#scripts})}"
  xmlns:th="http://www.thymeleaf.org"
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Todo List</title>
  </head>
  <body>
    <div id="content" class="p-2">
      <div class="level">
        <div class="level-left">
          <div class="level-item">
            <h1 class="title" th:text="${todo.title}">Title</h1>
          </div>
          <div class="level-item">
            <span class="tag is-primary is-normal is-rounded" th:text="${todo.isPublic ? 'Public' : 'Private'}">Primary</span>
          </div>
        </div>
        <div class="level-right">
          <div class="level-item">
            <a th:href="@{/todo/{todoId}/items/create(todoId=${todo.id})}" class="button is-primary">Add New Item</a>
          </div>
        </div>
      </div>
      <h6 class="subtitle is-5" th:text="${#temporals.format(todo.createdAt, 'MMM dd, yyyy')}">Subtitle</h6>
      <hr class="bd-hr" />
      <div class="container">
        <p class="mb-5" th:text="${todo.description}"></p>

        <nav class="panel">
          <div id="notificationWrap"></div>
            <p class="panel-heading"></p>
            <div class="panel-block">
              <p class="control has-icons-left">
                <input class="input" type="text" placeholder="Search" />
                <span class="icon is-left">
                  <i class="fas fa-search" aria-hidden="true"></i>
                </span>
              </p>
            </div>
            <p class="panel-tabs">
              <a th:class="${status.equals('all') ? 'is-active' : ''}" th:href="@{/todo/{todoId}(todoId=${todo.id})}">All</a>
              <a th:class="${status.equals('completed') ? 'is-active' : ''}" th:href="@{/todo/{todoId}?status=completed(todoId=${todo.id})}">Completed</a>
            </p>
            <label class="panel-block list_item" th:each="todoItem : ${todoItems}"
              th:id="'item-' + ${todoItem.id}">
              <input type="checkbox" th:data-itemId="${todoItem.id}" th:checked="${todoItem.isCompleted}" />
              <span th:text="${todoItem.title}">Task name</span>
            </label>
          </nav>
      </div>
    </div>
    <div id="scripts">
      <script th:inline="javascript">
        var notificationHtml = '<div class="notification mb-2 {class}"><button class="delete"></button>{content}</div>';
        $(document).ready(function(){
          $(".list_item input[type='checkbox']").on("change",function(){
            var itemId = $(this).data("itemid");
            var url = /*[[@{/todo/{todoId}/items/{itemId}/change-status(todoId=${todo.id})}]]*/ "";
            url =  url.replace("{itemId}", itemId);
            var isChecked = $(this).is(":checked");
            $.ajax({
              // contentType: "application/json",
              type: "POST",
              url: url,
              data: {"isChecked": isChecked ? "yes" : "no"},
              beforeSend: function(xhr) {
                $("#notificationWrap").html("");
              },
              success: function(response) {
                if(response.status == "success"){
                  var successNotification = notificationHtml.replace("{class}", "is-success").replace("{content}", "Item status changed successfully");
                  $("#notificationWrap").html(successNotification);
                }
              },
              error: function(error) {
                var errorNotification = notificationHtml.replace("{class}", "is-danger").replace("{content}", response.errors.join("<br/>"));
                $("#notificationWrap").html(errorNotification);
              }
            });
          });
        });
      </script>
    </div>
  </body>
</html>
